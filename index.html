<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body {
    background-color: rgb(215, 197, 231);
    display: flex;
    flex-direction: column;
  }

  #titleCont {
    width: 100vw;
    justify-content: center;
    display: flex;
  }

  #title {
    display: inline-block;
    font-family: "Lilita One", sans-serif;
    font-weight: 400;
    font-style: normal;
    font-size: 40px;
    color: deeppink;
    -webkit-text-stroke: 1px black;

  }

  #chart {
    width: 500px;
    height: 500px;
  }

  #datacont{
    display:flex;
    flex-direction: row;
  }

  #teams{
    width: 125px;
    height:600px;
    border: 1px solid deeppink;
    border-radius: 5px;
    background-color: deeppink;
    display: flex;
    text-align: center;
    justify-content: center;
  }
</style>

<body>

  <script src="https://d3js.org/d3.v4.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Quattrocento+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Sacramento&display=swap"
    rel="stylesheet">

  <div id="titleCont">
    <h1 id="title">Star Signs by Team</h1>
  </div>
  <div id="datacont">
    <div id="my_dataviz">

    </div>
    <div id="teams">data:</div>
  </div>

  <!-- <div id="chart">
    <canvas id="myChart" width="400" height="400"></canvas>
  </div> -->
  <script>

    // set the dimensions and margins of the graph
    var margin = { top: 10, right: 30, bottom: 20, left: 50 },
      width = 600 - margin.left - margin.right,
      height = 600 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select("#my_dataviz")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");
    // Load data
    Promise.all([
      fetch('https://raw.githubusercontent.com/lilygarfinkel/bsbl/main/bbl.json').then(response => response.json()),
      fetch('https://raw.githubusercontent.com/lilygarfinkel/bsbl/gh-pages/counts.json').then(response => response.json()),
      fetch('https://raw.githubusercontent.com/lilygarfinkel/bsbl/main/bysign.json').then(response => response.json())
    ]).then(([data, counts, bysign]) => {


      // Prepare data
      const sign = Object.keys(bysign);
      const groups = Object.keys(bysign).map(key => ({ key: key, data: bysign[key] }));


      const group = []
      for (s in groups) {
        let g = {}
        g['key'] = groups[s].key;
        for (t in groups[s].data) {
          g[t] = groups[s].data[t];

        }
        group.push(g)
      }
       console.log(group)

      //       console.log(sign)
      //       // console.log(team_data)
      //       console.log(groups)

      var subgroups = ["angels", "astros", "athletics", "bluejays", "braves", "brewers", "cardinals", "cubs", "diamondbacks", "dodgers", "giants", "guardians", "mariners", "marlins", "mets", "nationals", "orioles", "padres", "pirates", "phillies", "rangers", "rays", "reds", "redsox", "rockies", "royals", "tigers", "twins", "whitesox", "yankees"]
      // console.log(subgroups)
      // bySign.columns.slice(1)
      // var groups1 = d3.map(bysign, function(d){return(d.key)}).keys()
      // console.log(group)
      var x = d3.scaleBand()
        .domain(sign)
        .range([0, width])
        .padding([0.2])
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x).tickSizeOuter(0));

      // Add Y axis
      var y = d3.scaleLinear()
        .domain([0, 115])
        .range([height, 0]);
      svg.append("g")
        .call(d3.axisLeft(y));

      // color palette = one color per signs
      var color = d3.scaleOrdinal()
        .domain(subgroups)
        .range(['#BA0021', '#EB6E1F', '#003831', '#134A8E', '#CE1141', '#FFC52F', '#C41E3A', '#0E3386', '#A71930', '#005A9C', '#FD5A1E', '#E50022', '#0C2C56', '#00A3E0', '#FF5910', '#AB0003', '#DF4601', '#2F241D', '#E81828', '#FDB827', '#003278', '#8FBCE6', '#377eb8', '#BD3039', 'purple', '#C6011F', 'orange', '#004687', '#C0c0c0', '#002B5C'])

      var total = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

      for (e in groups) {
        //  console.log(groups[e])
        for (d in groups[e].data) {
          var smallarr = groups[e].data[d]
          // console.log(groups[e].data[d])
          if (d === 0) {
            total[e] = 0;
          }
          // console.log(total[e])
          total[e] = total[e] + groups[e].data[d];
          // console.log(total[e])
        }
      }

      console.log(total)

      var tot = d3.scaleOrdinal()
        .domain(sign)
        .range(total)
      // console.log(tot)
      //stack the data? --> stack per signs
      var stackGen = d3.stack()
        .keys(subgroups)

      var stackedData = stackGen(group)
      // ----------------
      // Create a tooltip
      // ----------------
      var tooltip = d3.select("#my_dataviz")
        .append("div")
        .style("opacity", 0)
        .attr("class", "tooltip")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "1px")
        .style("border-radius", "5px")
        .style("padding", "10px")

      // Three function that change the tooltip when user hover / move / leave a cell
      var mouseover = function (d) {
        var subgroupName = d3.select(this.parentNode).datum().key;
        var subgroupValue = d.data[subgroupName];
        var totalVal = tot(d.data.key);

        // console.log(totalVal)
        var container = document.getElementById("teams");
        var text =''
        console.log(d.data)
          for (i in d.data){
            console.log(i);
            console.log(d.data[i])
            text =text + " " + i + ' : ' + d.data[i] + '<br/>'
            // text.push('<br>')
          }
       
        container.innerHTML = text

        // d3.selectAll(".myRect").style("opacity", 0.2)
        d3.selectAll("." + subgroupName).style("opacity", 1)
        tooltip
          .html("team: " + subgroupName + "<br>" + "count: " + subgroupValue + "<br>" + "total: " + totalVal)
          .style("opacity", 1)
      }
      var mousemove = function (d) {
        var subgroupName = d3.select(this.parentNode).datum().key;
        tooltip
          .style("left", (d3.mouse(this)[0] + 90) + "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
          .style("top", (d3.mouse(this)[1]) + "px")
          .style("width", '150px')
          .style("background-color", color(subgroupName))
          .style('color', 'white')
      }
      var mouseleave = function (d) {
        d3.selectAll(".myRect")
          .style("opacity", 0.8)
        tooltip
          .style("opacity", 0)
      }
      // console.log(stackedData)
      // Show the bars
      // }); 
      svg.append("g")
        .selectAll("g")
        // Enter in the stack data = loop key per key = group per group
        .data(stackedData)
        .enter().append("g")
        .attr("fill", function (d) { return color(d.key); })
        .attr("class", function (d) { return "myRect " + d.key }) // Add a class to each subgroup: their name
       
      .text(function(d) { return tot(sign.indexOf(d)); })
        .selectAll("rect")
        // enter a second time = loop signs per signs to add all rectangles
        .data(function (d) { ;return d; })
        .enter().append("rect")
        .attr("x", function (d) { if (typeof d.data === 'string') { return; } else { return x(d.data.key); } })
        .attr("y", function (d) { if (Number.isNaN(y(d[1]))) { return } else { return y(d[1]); } })
        .attr("height", function (d) { if (Number.isNaN(y(d[1]))) { return } else { return (y(d[0]) - y(d[1])); } })
        .attr("width", x.bandwidth())
        .on("mouseover", mouseover)
        .on("mousemove", mousemove)
        .on("mouseleave", mouseleave);

    //     svg.append("g").selectAll("g")
    //     .data(sign)
    //     .enter()        
    //  .append("text")
    //    .attr("x", function(d) { return(x(d)); })
    //     .attr("y", function(d) {return(y(d[1])) ; }) // Center text
    //         .attr("dy", "1em")
    //   .text(function(d) { return tot(sign.indexOf(d)); });
        
    })


  </script>
</body>
